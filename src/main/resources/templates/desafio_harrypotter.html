<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Desaf√≠o - Harry Potter</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      min-height: 100vh;
      color: #EAEAEA;
      background: linear-gradient(to bottom, #1e1e3f, #0d0d26);
      position: relative;
      margin-right: 310px;
      overflow-x: hidden;
    }

    .background-magic {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
        opacity: 0.6;
    }

    .background-magic::before {
        content: '';
        position: absolute;
        width: 4px;
        height: 4px;
        background: #FFD700;
        box-shadow: 200px 800px #FFD700, 150px 200px #DAA520, 300px 120px #FFC107, 450px 600px #FFD700,
                    50px 900px #DAA520, 250px 300px #FFC107, 400px 450px #FFD700, 100px 550px #DAA520,
                    350px 650px #FFC107, 200px 750px #FFD700, 500px 850px #DAA520, 150px 950px #FFC107;
        animation: magic-float 15s infinite linear;
    }

    .background-magic::after {
        content: '';
        position: absolute;
        width: 3px;
        height: 3px;
        background: #FFC107;
        box-shadow: 100px 100px #DAA520, 220px 400px #FFD700, 400px 500px #FFC107, 10px 700px #DAA520,
                    300px 800px #FFD700, 500px 900px #FFC107;
        animation: magic-float 10s infinite linear 5s;
    }

    @keyframes magic-float {
        0% { transform: translateY(100vh); opacity: 0.5; }
        100% { transform: translateY(-100vh); opacity: 1; }
    }

    .layout {
        width: 100%;
        z-index: 2;
    }

    .center {
        padding: 100px 40px 40px 40px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #EAEAEA;
        position: relative;
    }

    h1 {
        color: #FFD700;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        position: relative;
        z-index: 2;
    }

    .portada {
        width: 200px;
        height: 280px;
        border-radius: 6px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        background-image: url('/desafio/images/harrypotter.jpg');
        background-size: cover;
        background-position: center;
        margin-bottom: 15px;
        border: 3px solid #8e44ad;
        position: relative;
        z-index: 2;
    }

    p {
        max-width: 700px;
        line-height: 1.6;
        color: #CFCFCF;
        font-size: 1rem;
        position: relative;
        z-index: 2;
    }

    .capitulos {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
        margin-top: 30px;
        margin-bottom: 60px;
        padding-bottom: 100px;
        position: relative;
        z-index: 2;
    }

    .capitulo-nodo {
        width: 85px;
        height: 85px;
        border-radius: 50%;
        background: #8e44ad;
        border: 3px solid #FFD700;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        box-shadow: 0 0 15px rgba(142, 68, 173, 0.5);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        font-size: 1.2rem;
    }

    .capitulo-nodo.locked {
        opacity: 0.6;
        cursor: not-allowed;
        background: #5D3FD3;
        border-color: #A0A0A0;
    }

    .capitulo-nodo.locked::after {
        content: "‚ú®";
        position: absolute;
        font-size: 1.2rem;
        opacity: 0.8;
    }

    .capitulo-nodo.leido {
        background: #FFD700;
        color: #333;
        transform: scale(1.1);
        box-shadow: 0 0 20px #FFD700;
    }

    .flecha {
        color: #FFD700;
        margin: 6px 0;
        font-size: 1.2rem;
        opacity: 0.8;
        animation: arrow-pulse 1s infinite alternate;
    }

    @keyframes arrow-pulse {
        from { opacity: 0.5; }
        to { opacity: 1; }
    }

    .sidebar {
        width: 260px;
        background: linear-gradient(180deg, #1e1e3f, #0d0d26);
        border-left: 3px solid #FFD700;
        padding: 30px 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        color: #fff;
        border-top-left-radius: 25px;
        border-bottom-left-radius: 25px;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.4);
        position: fixed;
        top: 0;
        right: 0;
        height: 100vh;
        z-index: 10;
        overflow-y: auto;
    }

    .sidebar::-webkit-scrollbar { width: 8px; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(255, 215, 0, 0.4); border-radius: 10px; }

    .sidebar h2 {
        text-align: center;
        color: #FFD700;
        margin-bottom: 30px;
        font-weight: 700;
        font-size: 1.6rem;
        letter-spacing: 1px;
        text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
    }

    .sidebar ul { list-style: none; padding: 0; }

    .sidebar li {
        margin: 18px 0;
        cursor: pointer;
        color: #EAEAEA;
        font-weight: 500;
        font-size: 1.05rem;
        padding: 10px 15px;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: rgba(142, 68, 173, 0.15);
    }

    .sidebar li:hover {
        color: #fff;
        background: rgba(142, 68, 173, 0.35);
        transform: translateX(-4px);
    }

    .footer {
        text-align: center;
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-top: 20px;
        opacity: 0.8;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: #F8F8F8;
        padding: 25px;
        border-radius: 10px;
        max-width: 600px;
        text-align: left;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        max-height: 80vh;
        overflow-y: auto;
        color: #222;
    }

    .modal-content h3 { color: #5D3FD3; margin-bottom: 15px; text-align: center; }

    .modal-content button {
        background: #8e44ad;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 10px 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .modal-content button:hover { background: #5D3FD3; }

    .mensaje-motivacional {
        display: none;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #8e44ad;
        color: #FFD700;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        z-index: 200;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.5s ease;
        border: 2px solid #FFD700;
    }

    .mensaje-motivacional.show { display: block; opacity: 1; }
  </style>
</head>
<body>

<div class="background-magic"></div>

<div class="layout">
  <div class="center">
    <div class="portada"></div>
    <h1>Harry Potter y la piedra filosofal</h1>
    <p>Un viaje m√°gico que te invita a descubrir el valor de la amistad, el coraje y la magia que vive en cada uno de nosotros.</p>
    <div class="capitulos" id="capitulosList"></div>
  </div>

  <aside class="sidebar">
    <div>
      <h2>LECTIO</h2>
      <ul>
        <li onclick="location.href='/api/inicio'">üè† Inicio</li>
        <li onclick="location.href='/api/libros'">üìö Biblioteca</li>
        <li onclick="location.href='/api/historia_pensamiento'">üí° Historia del Pensamiento</li>
        <li onclick="location.href='/api/logiado'">üè† Volver a Lectio</li>
      </ul>
    </div>
    <div class="footer">¬© 2025 Lectio</div>
  </aside>
</div>

<div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-content">
    <h3 id="modal-title">Cap√≠tulo</h3>
    <div id="modal-body" style="white-space:pre-wrap;color:#333"></div>
    <button id="modal-button" onclick="handleModalButtonClick()">Completar</button>
  </div>
</div>

<div id="mensaje" class="mensaje-motivacional"></div>

<script>
  const capitulos = [
    `Cap√≠tulo 1: El ni√±o que sobrevivi√≥ y la magia escondida.

En una noche oscura, un anciano con capa p√∫rpura, Albus Dumbledore, y una mujer con forma de gata, la Profesora McGonagall, observaban una casa com√∫n en Privet Drive. En los brazos de un gigante llamado Hagrid, tra√≠an a un beb√© con una cicatriz en forma de rayo. Era Harry Potter. Voldemort lo hab√≠a atacado, y el sacrificio de su madre, Lily, hab√≠a dejado una protecci√≥n m√°gica que nadie comprend√≠a. Aquella noche, el mundo m√°gico celebr√≥, sin saber que aquel ni√±o, dejado a la puerta de sus t√≠os muggles (los Dursley), cambiar√≠a el destino de todos. Harry fue depositado con una nota explicando su pasado y su destino. Sin embargo, los Dursley, temerosos de todo lo que fuera "anormal," lo escondieron y lo trataron como un intruso, oblig√°ndolo a vivir bajo las escaleras.`,

    `Cap√≠tulo 2: La llamada de Hogwarts.

Harry Potter creci√≥ creyendo que era un ni√±o completamente normal, aunque la extra√±a suerte lo segu√≠a a donde fuera. Viv√≠a bajo las escaleras, invisible para los Dursley y acosado por su primo Dudley. Pero al cumplir once a√±os, su vida dio un giro radical. Una carta lleg√≥ dirigida a √©l, a "La alacena bajo la escalera." Intentaron esconderla, bloquearla, y finalmente, huyeron a una caba√±a en un islote para escapar de la avalancha de correo. Fue all√≠, en medio de la tormenta, que un gigante llamado Hagrid derrib√≥ la puerta y, con una voz atronadora, le revel√≥ la verdad: "Eres un mago, Harry." Hagrid le explic√≥ su historia, la verdad sobre la muerte de sus padres y la existencia de Hogwarts, la escuela de magia y hechicer√≠a. Harry, aturdido, acept√≥ su destino.`,

    `Cap√≠tulo 3: Amistad y la Ceremonia de Selecci√≥n.

Hagrid llev√≥ a Harry al Callej√≥n Diagon, donde compr√≥ su varita (hermana de la de Voldemort), sus libros y su lechuza, Hedwig. En la estaci√≥n de King's Cross, Harry encontr√≥ el and√©n 9¬æ y subi√≥ al Expreso de Hogwarts. All√≠ conoci√≥ a Ronald Weasley, su primer amigo verdadero, y a Hermione Granger, una bruja brillante y algo sabelotodo. Juntos, llegaron al majestuoso Castillo de Hogwarts. En el Gran Comedor, frente a miles de alumnos, el Sombrero Seleccionador deliber√≥ sobre su destino. Tras un debate interno, el Sombrero grit√≥: "¬°Gryffindor!". Harry, Ron y Hermione fueron asignados a la casa del coraje, uniendo fuerzas para lo que ser√≠a el inicio de una amistad eterna.`,

    `Cap√≠tulo 4: El espejo de Oesed y los deseos del coraz√≥n.

La vida en Hogwarts fue emocionante, llena de lecciones de pociones con el temido Snape y partidos de Quidditch. Durante las vacaciones de Navidad, Harry descubri√≥ un espejo misterioso en una sala abandonada. Al mirarse, no vio su reflejo, sino la imagen de sus padres, sonri√©ndole. Se obsesion√≥ con el espejo, volviendo noche tras noche. El profesor Dumbledore lo encontr√≥ y, con paciencia, le explic√≥ la naturaleza del artefacto: "No sirve para mostrarnos la verdad, sino los deseos m√°s profundos y desesperados de nuestro coraz√≥n." Dumbledore le advirti√≥ que la felicidad no se encuentra en so√±ar con lo que no se puede tener. Harry comprendi√≥ que la magia m√°s poderosa no eran los hechizos, sino el amor y la conexi√≥n con sus amigos, que ahora eran su verdadera familia.`,

    `Cap√≠tulo 5: El valor de la amistad y la protecci√≥n final.

Harry, Ron y Hermione descubrieron que la Piedra Filosofal, capaz de conceder la inmortalidad, estaba escondida en Hogwarts. Creyendo que el Profesor Snape intentaba robarla para Voldemort, decidieron actuar. Juntos, enfrentaron pruebas imposibles bajo el castillo: el perro de tres cabezas, trampas de plantas venenosas, el ajedrez m√°gico gigante de McGonagall y acertijos de pociones. En el √∫ltimo desaf√≠o, Harry se encontr√≥ cara a cara, no con Snape, sino con el Profesor Quirrell, quien llevaba a Voldemort pegado a su nuca. La protecci√≥n de su madre se activ√≥. Cuando Quirrell toc√≥ a Harry, se desvaneci√≥ en cenizas. La Piedra fue destruida. Dumbledore le dijo despu√©s: "No fue tu magia la que te salv√≥, Harry, fue el amor de tu madre. El amor que te dio es una marca que Voldemort no puede soportar." Harry regres√≥ a Privet Drive, sabiendo que Hogwarts ser√≠a su hogar para siempre.`
  ];

  const mensajesMotivacionales = [
      "Has dado el primer paso a tu destino. ¬°No dejes que los muggles apaguen la chispa!",
      "Cada carta abre un nuevo camino. ¬°Acepta la llamada de tu propia aventura!",
      "Has encontrado a tu equipo. La amistad es el hechizo m√°s fuerte que existe. ¬°Adelante, Gryffindor!",
      "Mira m√°s all√° del reflejo: el valor m√°s grande es amar sin obsesi√≥n. ¬°Tu coraz√≥n es tu mejor br√∫jula!",
      "La aventura ha terminado, pero tu magia interior permanece. ¬°Recuerda, el amor es la magia m√°s poderosa! ‚ö°"
  ];

  const LIBRO_ID = 'harrypotter';
  const cont = document.getElementById('capitulosList');
  let currentReadingChapterIndex = -1;
  let capitulosLeidos = [];

  async function cargarProgreso() {
      try {
          const response = await fetch('/api/progreso/mi-progreso', {
              method: 'GET',
              credentials: 'include'
          });

          if (!response.ok) {
              console.log('Usuario no autenticado');
              desbloquearSiguientes();
              return;
          }

          const data = await response.json();

          if (data.capitulosPorLibro && data.capitulosPorLibro[LIBRO_ID]) {
              capitulosLeidos = Array.from(data.capitulosPorLibro[LIBRO_ID]);
          }

          desbloquearSiguientes();
      } catch (error) {
          console.error('Error cargando progreso:', error);
          desbloquearSiguientes();
      }
  }

  async function guardarProgreso(capituloIndex) {
      try {
          const response = await fetch('/api/progreso/guardar-capitulo', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                  libroId: LIBRO_ID,
                  capitulo: capituloIndex,
                  totalCapitulos: capitulos.length
              })
          });

          if (response.ok) {
              const data = await response.json();
              console.log('‚úÖ Cap√≠tulo guardado:', data);

              if (capitulosLeidos.length === capitulos.length) {
                  mostrarMensaje('üéâ ¬°Felicitaciones! Has completado Harry Potter. +100 puntos ‚ö°');
              }
          }
      } catch (error) {
          console.error('Error guardando progreso:', error);
      }
  }

  capitulos.forEach((txt, i) => {
      const nodo = document.createElement('div');
      nodo.className = 'capitulo-nodo locked';
      nodo.textContent = i + 1;
      nodo.onclick = () => openModal(i);
      cont.appendChild(nodo);
      if (i < capitulos.length - 1) {
          const f = document.createElement('div');
          f.className = 'flecha';
          f.innerHTML = '&#8595;';
          cont.appendChild(f);
      }
  });

  function desbloquearSiguientes() {
      const nodos = document.querySelectorAll('.capitulo-nodo');
      nodos.forEach((n, i) => {
          if (i === 0 || capitulosLeidos.includes(i - 1)) {
              n.classList.remove('locked');
          }
          if (capitulosLeidos.includes(i)) n.classList.add('leido');
      });
  }

  function openModal(i) {
      const nodo = document.querySelectorAll('.capitulo-nodo')[i];
      if (nodo.classList.contains('locked')) return;

      document.getElementById('modal-title').innerText = `Cap√≠tulo ${i + 1}`;
      document.getElementById('modal-body').innerText = capitulos[i];

      const modalButton = document.getElementById('modal-button');
      if (capitulosLeidos.includes(i)) {
          modalButton.innerText = 'Cerrar';
          modalButton.onclick = () => closeModal();
      } else {
          modalButton.innerText = 'Completar';
          modalButton.onclick = () => handleModalButtonClick();
      }

      document.getElementById('modal').style.display = 'flex';
      currentReadingChapterIndex = i;
  }

  function handleModalButtonClick() {
      if (document.getElementById('modal-button').innerText === 'Completar') {
          closeModal();
      } else {
          document.getElementById('modal').style.display = 'none';
      }
  }

  function closeModal() {
      document.getElementById('modal').style.display = 'none';

      const i = currentReadingChapterIndex;

      if (i >= 0 && !capitulosLeidos.includes(i)) {
          capitulosLeidos.push(i);
          guardarProgreso(i);
          mostrarMensaje(mensajesMotivacionales[i % mensajesMotivacionales.length]);

          const nodo = document.querySelectorAll('.capitulo-nodo')[i];
          nodo.classList.add('leido');
          desbloquearSiguientes();
      }

      currentReadingChapterIndex = -1;
  }

  function mostrarMensaje(text) {
      const mensaje = document.getElementById('mensaje');
      mensaje.textContent = text;
      mensaje.classList.add('show');
      setTimeout(() => { mensaje.classList.remove('show'); }, 4000);
  }

  window.onload = cargarProgreso;
</script>
</body>
</html>